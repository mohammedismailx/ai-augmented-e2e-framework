# DB Module Flow Diagrams

This document contains flow diagrams describing all execution flows for the Database testing module.

---

## 1. Main DB Intent Execution Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DB INTENT EXECUTION FLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  User Intent │
                              │  (Natural    │
                              │   Language)  │
                              └──────┬───────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  STEP 1: Query        │
                         │  Schema Context       │
                         │  from ChromaDB        │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  STEP 2: AI Generates │
                         │  SQL Query            │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  STEP 3: Execute      │
                         │  SQL Query            │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  STEP 4: AI Analyzes  │
                         │  Query Result         │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  STEP 5: Return       │
                         │  Final Result         │
                         └───────────────────────┘
```

---

## 2. Schema Context Retrieval Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SCHEMA CONTEXT RETRIEVAL FLOW                          │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  User Intent │
                              │  "get all    │
                              │   customers" │
                              └──────┬───────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Query db_context     │
                         │  Collection           │
                         │  in ChromaDB          │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Semantic Search      │
                         │  Returns Matching     │
                         │  Tables/Schemas       │
                         └───────────┬───────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────┐
                    │          SCHEMA CONTEXT             │
                    │  ─────────────────────────────────  │
                    │  Table: customers                   │
                    │  Columns:                           │
                    │  • id (INT, PRIMARY KEY)            │
                    │  • name (VARCHAR)                   │
                    │  • email (VARCHAR)                  │
                    │  • created_at (DATETIME)            │
                    │  Foreign Keys:                      │
                    │  • orders.customer_id → id          │
                    └─────────────────────────────────────┘
```

---

## 3. SQL Query Generation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       SQL QUERY GENERATION FLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │            INPUT TO AI              │
                    │  ─────────────────────────────────  │
                    │  • User Intent                      │
                    │  • Database Schema Context          │
                    │  • Table Relationships              │
                    └─────────────────┬───────────────────┘
                                      │
                                      ▼
                         ┌───────────────────────┐
                         │  Send Prompt to       │
                         │  GitLab Duo / AI      │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  AI Analyzes:         │
                         │  • Intent keywords    │
                         │  • Table names        │
                         │  • Column references  │
                         │  • Conditions         │
                         │  • Aggregations       │
                         └───────────┬───────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────┐
                    │          AI GENERATES               │
                    │  ─────────────────────────────────  │
                    │  {                                  │
                    │    "query": "SELECT * FROM          │
                    │              customers WHERE        │
                    │              status = 'active'",    │
                    │    "explanation": "Retrieves all    │
                    │                    active customers"│
                    │  }                                  │
                    └─────────────────────────────────────┘
```

---

## 4. SQL Query Execution Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       SQL QUERY EXECUTION FLOW                              │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  SQL Query   │
                              └──────┬───────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Validate Query       │
                         │  (Prevent injection)  │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Execute via          │
                         │  DB Connector         │
                         │  (MySQL/PostgreSQL)   │
                         └───────────┬───────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │                                 │
                    ▼                                 ▼
        ┌───────────────────┐             ┌───────────────────┐
        │  Query SUCCESS    │             │  Query FAILED     │
        └─────────┬─────────┘             └─────────┬─────────┘
                  │                                 │
                  ▼                                 ▼
        ┌───────────────────┐             ┌───────────────────┐
        │  Return Data:     │             │  Return Error:    │
        │  • Rows           │             │  • Error message  │
        │  • Row count      │             │  • Query executed │
        │  • Column names   │             │                   │
        └───────────────────┘             └───────────────────┘
```

---

## 5. Query Result Analysis Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      QUERY RESULT ANALYSIS FLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │          INPUT TO AI                │
                    │  ─────────────────────────────────  │
                    │  • User Intent                      │
                    │  • SQL Query Executed               │
                    │  • Query Result (data)              │
                    │  • Error (if any)                   │
                    └─────────────────┬───────────────────┘
                                      │
                                      ▼
                         ┌───────────────────────┐
                         │  Send Analysis        │
                         │  Prompt to AI         │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  AI Evaluates:        │
                         │  1. Query executed    │
                         │     successfully?     │
                         │  2. Data returned     │
                         │     meets intent?     │
                         │  3. Verification      │
                         │     conditions met?   │
                         └───────────┬───────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────┐
                    │          AI RETURNS                 │
                    │  ─────────────────────────────────  │
                    │  {                                  │
                    │    "success": true/false,           │
                    │    "reason": "Query returned 15     │
                    │               active customers..."  │
                    │  }                                  │
                    └─────────────────────────────────────┘
```

---

## 6. Intent Type Classification Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     INTENT TYPE CLASSIFICATION FLOW                         │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  User Intent │
                              └──────┬───────┘
                                     │
         ┌───────────┬───────────┬───┴───┬───────────┬───────────┐
         │           │           │       │           │           │
         ▼           ▼           ▼       ▼           ▼           ▼
    ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
    │  "get"  │ │ "count" │ │ "check" │ │"verify" │ │ "find"  │ │"compare"│
    │  "list" │ │ "total" │ │  "has"  │ │"ensure" │ │ "search"│ │         │
    │ "fetch" │ │ "how    │ │"exists" │ │"confirm"│ │ "where" │ │         │
    │         │ │  many"  │ │         │ │         │ │         │ │         │
    └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
         │           │           │           │           │           │
         ▼           ▼           ▼           ▼           ▼           ▼
    ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
    │ SELECT  │ │ SELECT  │ │ SELECT  │ │ SELECT  │ │ SELECT  │ │ SELECT  │
    │  * or   │ │ COUNT(*)│ │ EXISTS  │ │  with   │ │  with   │ │  with   │
    │ columns │ │         │ │  check  │ │  assert │ │  WHERE  │ │  JOIN   │
    └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘
```

---

## 7. Database Schema Embedding Flow (Initialization)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DATABASE SCHEMA EMBEDDING FLOW                           │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │   Database   │
                              │  Connection  │
                              └──────┬───────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Get All Tables       │
                         │  SHOW TABLES          │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  For Each Table:      │
                         │  Get Schema Info      │
                         └───────────┬───────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              │                      │                      │
              ▼                      ▼                      ▼
    ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
    │  Get Columns     │  │  Get Foreign     │  │  Get Indexes     │
    │  DESCRIBE table  │  │  Keys            │  │  (optional)      │
    └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘
             │                     │                     │
             └─────────────────────┼─────────────────────┘
                                   │
                                   ▼
                    ┌─────────────────────────────────────┐
                    │         CREATE DOCUMENT             │
                    │  ─────────────────────────────────  │
                    │  {                                  │
                    │    "table_name": "customers",       │
                    │    "columns": [                     │
                    │      {"name": "id", "type": "INT"}, │
                    │      {"name": "name", "type":       │
                    │       "VARCHAR(255)"}               │
                    │    ],                               │
                    │    "foreign_keys": [                │
                    │      {"column": "...", "ref": "..."}│
                    │    ]                                │
                    │  }                                  │
                    └─────────────────┬───────────────────┘
                                      │
                                      ▼
                         ┌───────────────────────┐
                         │  Embed in ChromaDB    │
                         │  db_context           │
                         │  Collection           │
                         └───────────────────────┘
```

---

## 8. Full DB Execution Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       FULL DB EXECUTION PIPELINE                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: GET SCHEMA CONTEXT                                                   │
│ ┌────────────┐    ┌────────────┐    ┌────────────┐                          │
│ │   Intent   │───▶│  ChromaDB  │───▶│   Schema   │                          │
│ │            │    │  Query     │    │  Context   │                          │
│ └────────────┘    └────────────┘    └────────────┘                          │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: AI GENERATES SQL QUERY                                               │
│ ┌────────────┐    ┌────────────┐    ┌────────────┐                          │
│ │  Intent +  │───▶│  GitLab    │───▶│    SQL     │                          │
│ │   Schema   │    │   Duo      │    │   Query    │                          │
│ └────────────┘    └────────────┘    └────────────┘                          │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: EXECUTE SQL QUERY                                                    │
│ ┌────────────┐    ┌────────────┐    ┌────────────┐                          │
│ │    SQL     │───▶│    DB      │───▶│   Result   │                          │
│ │   Query    │    │ Connector  │    │   Data     │                          │
│ └────────────┘    └────────────┘    └────────────┘                          │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ STEP 4: AI ANALYZES RESULT                                                   │
│ ┌────────────┐    ┌────────────┐    ┌────────────┐                          │
│ │  Intent +  │───▶│  GitLab    │───▶│  Analysis  │                          │
│ │   Result   │    │   Duo      │    │   Result   │                          │
│ └────────────┘    └────────────┘    └────────────┘                          │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ STEP 5: RETURN FINAL RESULT                                                  │
│ ┌────────────────────────────────────────────────────────────────────────┐  │
│ │  {                                                                      │  │
│ │    "success": true/false,                                               │  │
│ │    "query": "SELECT ...",                                               │  │
│ │    "data": [...],                                                       │  │
│ │    "reason": "Analysis explanation",                                    │  │
│ │    "error": null                                                        │  │
│ │  }                                                                      │  │
│ └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. DB Connection Management Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DB CONNECTION MANAGEMENT FLOW                          │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  Dashboard   │
                              │  Config      │
                              └──────┬───────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Receive DB Config:   │
                         │  • host               │
                         │  • port               │
                         │  • database           │
                         │  • username           │
                         │  • password           │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Create DBConnector   │
                         │  Instance             │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Attempt Connection   │
                         └───────────┬───────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │                                 │
                    ▼                                 ▼
        ┌───────────────────┐             ┌───────────────────┐
        │  Connected!       │             │  Connection       │
        │                   │             │  Failed           │
        └─────────┬─────────┘             └─────────┬─────────┘
                  │                                 │
                  ▼                                 ▼
        ┌───────────────────┐             ┌───────────────────┐
        │  Get All Tables   │             │  Return Error     │
        │  Embed Schema     │             │  Message          │
        │  Return Success   │             │                   │
        └───────────────────┘             └───────────────────┘
```

---

## 10. Verification Intent Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       VERIFICATION INTENT FLOW                              │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  Verify      │
                              │  Intent      │
                              │  "ensure     │
                              │   count > 5" │
                              └──────┬───────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  AI Generates Query   │
                         │  with Condition       │
                         │  SELECT COUNT(*) ...  │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Execute Query        │
                         │  Get Result: 12       │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  AI Analyzes:         │
                         │  • Intent: count > 5  │
                         │  • Result: 12         │
                         │  • 12 > 5 = TRUE      │
                         └───────────┬───────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────┐
                    │          RESULT                     │
                    │  ─────────────────────────────────  │
                    │  {                                  │
                    │    "success": true,                 │
                    │    "reason": "Count is 12, which    │
                    │               is greater than 5"   │
                    │  }                                  │
                    └─────────────────────────────────────┘
```

---

## 11. Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ERROR HANDLING FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  Query       │
                              │  Execution   │
                              └──────┬───────┘
                                     │
         ┌───────────┬───────────┬───┴───────────────────────┐
         │           │           │                           │
         ▼           ▼           ▼                           ▼
    ┌─────────┐ ┌─────────┐ ┌─────────────┐         ┌─────────────┐
    │ Syntax  │ │ Table   │ │ Permission  │         │ Connection  │
    │ Error   │ │ Not     │ │ Denied      │         │ Lost        │
    │         │ │ Found   │ │             │         │             │
    └────┬────┘ └────┬────┘ └──────┬──────┘         └──────┬──────┘
         │           │             │                       │
         └───────────┴─────────────┴───────────────────────┘
                                   │
                                   ▼
                         ┌───────────────────────┐
                         │  Capture Error        │
                         │  Message              │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Send to AI for       │
                         │  Analysis with Error  │
                         └───────────┬───────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────┐
                    │          RESULT                     │
                    │  ─────────────────────────────────  │
                    │  {                                  │
                    │    "success": false,                │
                    │    "query": "SELECT * FROM xyz",    │
                    │    "data": [],                      │
                    │    "reason": "Table 'xyz' does      │
                    │               not exist",          │
                    │    "error": "MySQL Error 1146"      │
                    │  }                                  │
                    └─────────────────────────────────────┘
```

---

## 12. Dashboard DB Test Runner Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     DASHBOARD DB TEST RUNNER FLOW                           │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │  Dashboard  │
    │  (Browser)  │
    └──────┬──────┘
           │
           ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    User Actions                                  │
    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
    │  │Configure│  │Add Test │  │Run Test │  │Run All  │            │
    │  │Database │  │ Intent  │  │ (Single)│  │ Tests   │            │
    │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘            │
    └───────┼────────────┼────────────┼────────────┼──────────────────┘
            │            │            │            │
            ▼            ▼            ▼            ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ POST /api/  │ │ Store in    │ │ POST /api/  │ │ POST /api/  │
    │ config/db   │ │ Local List  │ │ run         │ │ run-all     │
    └──────┬──────┘ └─────────────┘ └──────┬──────┘ └──────┬──────┘
           │                               │               │
           ▼                               ▼               ▼
    ┌─────────────┐                 ┌─────────────────────────────┐
    │ Test        │                 │        Flask Backend        │
    │ Connection  │                 │  ┌───────────────────────┐  │
    │ Embed       │                 │  │   execute_intent()    │  │
    │ Schema      │                 │  │   → get_db_context()  │  │
    └─────────────┘                 │  │   → execute_by_intent │  │
                                    │  └───────────────────────┘  │
                                    └──────────────┬──────────────┘
                                                   │
                                                   ▼
                                    ┌─────────────────────────────┐
                                    │         Return Result       │
                                    │  {                          │
                                    │    "success": true/false,   │
                                    │    "query": "...",          │
                                    │    "data": [...],           │
                                    │    "reason": "..."          │
                                    │  }                          │
                                    └─────────────────────────────┘
```

---

## Summary of DB Flows

| Flow                  | Description                              |
| --------------------- | ---------------------------------------- |
| Main Execution        | 5-step pipeline from intent to result    |
| Schema Retrieval      | Semantic search to find relevant tables  |
| Query Generation      | AI creates SQL from intent + schema      |
| Query Execution       | Execute SQL via DB connector             |
| Result Analysis       | AI evaluates if intent was fulfilled     |
| Intent Classification | Map intent verbs to SQL operations       |
| Schema Embedding      | Initialize by embedding DB structure     |
| Connection Management | Handle DB configuration and connection   |
| Verification          | Validate data conditions (count, exists) |
| Error Handling        | Capture and analyze query failures       |
| Dashboard Runner      | Web interface for interactive testing    |
